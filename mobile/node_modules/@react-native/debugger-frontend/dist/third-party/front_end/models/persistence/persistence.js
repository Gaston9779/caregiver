import*as e from"../../core/common/common.js";import*as t from"../../core/host/host.js";import*as s from"../../core/sdk/sdk.js";import*as n from"../bindings/bindings.js";import*as r from"../workspace/workspace.js";import*as i from"../../core/platform/platform.js";import*as o from"../text_utils/text_utils.js";import*as a from"../../core/i18n/i18n.js";import*as d from"../../ui/legacy/components/utils/utils.js";import*as l from"../breakpoints/breakpoints.js";import*as c from"../../ui/components/icon_button/icon_button.js";import*as h from"../../ui/legacy/legacy.js";import*as u from"../../core/root/root.js";const p={unableToReadFilesWithThis:"`PlatformFileSystem` cannot read files."},m=a.i18n.registerUIStrings("models/persistence/PlatformFileSystem.ts",p),g=a.i18n.getLocalizedString.bind(void 0,m);class f{pathInternal;typeInternal;constructor(e,t){this.pathInternal=e,this.typeInternal=t}getMetadata(e){return Promise.resolve(null)}initialFilePaths(){return[]}initialGitFolders(){return[]}path(){return this.pathInternal}embedderPath(){throw new Error("Not implemented")}type(){return this.typeInternal}async createFile(e,t){return Promise.resolve(null)}deleteFile(e){return Promise.resolve(!1)}requestFileBlob(e){return Promise.resolve(null)}async requestFileContent(e){return{content:null,error:g(p.unableToReadFilesWithThis),isEncoded:!1}}setFileContent(e,t,s){throw new Error("Not implemented")}renameFile(e,t,s){s(!1)}addExcludedFolder(e){}removeExcludedFolder(e){}fileSystemRemoved(){}isFileExcluded(e){return!1}excludedFolders(){return new Set}searchInPath(e,t){return Promise.resolve([])}indexContent(e){queueMicrotask((()=>{e.done()}))}mimeFromPath(e){throw new Error("Not implemented")}canExcludeFolder(e){return!1}contentType(e){throw new Error("Not implemented")}tooltipForURL(e){throw new Error("Not implemented")}supportsAutomapping(){throw new Error("Not implemented")}}var S=Object.freeze({__proto__:null,PlatformFileSystem:f});const y={fileSystemErrorS:"File system error: {PH1}",blobCouldNotBeLoaded:"Blob could not be loaded.",cantReadFileSS:"Can't read file: {PH1}: {PH2}",unknownErrorReadingFileS:"Unknown error reading file: {PH1}",linkedToS:"Linked to {PH1}"},P=a.i18n.registerUIStrings("models/persistence/IsolatedFileSystem.ts",y),F=a.i18n.getLocalizedString.bind(void 0,P);class w extends f{manager;embedderPathInternal;domFileSystem;excludedFoldersSetting;excludedFoldersInternal;excludedEmbedderFolders;initialFilePathsInternal;initialGitFoldersInternal;fileLocks;constructor(t,s,n,r,i){super(s,i),this.manager=t,this.embedderPathInternal=n,this.domFileSystem=r,this.excludedFoldersSetting=e.Settings.Settings.instance().createLocalSetting("workspaceExcludedFolders",{}),this.excludedFoldersInternal=new Set(this.excludedFoldersSetting.get()[s]||[]),this.excludedEmbedderFolders=[],this.initialFilePathsInternal=new Set,this.initialGitFoldersInternal=new Set,this.fileLocks=new Map}static async create(e,s,n,r,i,o){const a=t.InspectorFrontendHost.InspectorFrontendHostInstance.isolatedFileSystem(i,o);if(!a)return null;const d=new w(e,s,n,a,r);return d.initializeFilePaths().then((()=>d)).catch((e=>(console.error(e),null)))}static errorMessage(e){return F(y.fileSystemErrorS,{PH1:e.message})}serializedFileOperation(e,t){const s=Promise.resolve(this.fileLocks.get(e)).then((()=>t.call(null)));return this.fileLocks.set(e,s),s}getMetadata(t){let s;const n=new Promise((e=>{s=e}));return this.domFileSystem.root.getFile(e.ParsedURL.ParsedURL.encodedPathToRawPathString(t),void 0,(function(e){e.getMetadata(s,r)}),r),n;function r(e){const n=w.errorMessage(e);console.error(n+" when getting file metadata '"+t),s(null)}}initialFilePaths(){return[...this.initialFilePathsInternal]}initialGitFolders(){return[...this.initialGitFoldersInternal]}embedderPath(){return this.embedderPathInternal}initializeFilePaths(){return new Promise((s=>{let n=1,r=0,o=1;const a=function(i){for(let s=0;s<i.length;++s){const d=i[s];if(d.isDirectory){if(d.fullPath.endsWith("/.git")){const t=d.fullPath.lastIndexOf("/"),s=e.ParsedURL.ParsedURL.substr(d.fullPath,1,t);this.initialGitFoldersInternal.add(e.ParsedURL.ParsedURL.rawPathToEncodedPathString(s))}if(this.isFileExcluded(e.ParsedURL.ParsedURL.concatenate(e.ParsedURL.ParsedURL.rawPathToEncodedPathString(d.fullPath),"/"))){const s=e.ParsedURL.ParsedURL.concatenate(this.path(),e.ParsedURL.ParsedURL.rawPathToEncodedPathString(d.fullPath));this.excludedEmbedderFolders.push(e.ParsedURL.ParsedURL.urlToRawPathString(s,t.Platform.isWin()));continue}++o,++n,this.requestEntries(d.fullPath,a)}else{if(this.isFileExcluded(e.ParsedURL.ParsedURL.rawPathToEncodedPathString(d.fullPath)))continue;++r,this.initialFilePathsInternal.add(e.ParsedURL.ParsedURL.rawPathToEncodedPathString(e.ParsedURL.ParsedURL.substr(d.fullPath,1)))}}0==--n&&(s(),""===this.type()&&t.userMetrics.workspacesNumberOfFiles(r,o))}.bind(this);this.requestEntries(i.DevToolsPath.EmptyRawPathString,a)}))}async createFoldersIfNotExist(e){let t=await new Promise((t=>this.domFileSystem.root.getDirectory(e,void 0,t,(()=>t(null)))));if(t)return t;const s=e.split("/");let n="";for(const e of s)if(n=n+"/"+e,t=await this.innerCreateFolderIfNeeded(n),!t)return null;return t}innerCreateFolderIfNeeded(e){return new Promise((t=>{this.domFileSystem.root.getDirectory(e,{create:!0},(e=>t(e)),(s=>{const n=w.errorMessage(s);console.error(n+" trying to create directory '"+e+"'"),t(null)}))}))}async createFile(t,s){const n=await this.createFoldersIfNotExist(e.ParsedURL.ParsedURL.encodedPathToRawPathString(t));if(!n)return null;const r=await this.serializedFileOperation(t,function s(r,i){return new Promise((o=>{const a=e.ParsedURL.ParsedURL.concatenate(r,(i||"").toString());n.getFile(a,{create:!0,exclusive:!0},o,(e=>{if("InvalidModificationError"===e.name)return void o(s.call(this,r,i?i+1:1));const n=w.errorMessage(e);console.error(n+" when testing if file exists '"+this.path()+"/"+t+"/"+a+"'"),o(null)}))}))}.bind(this,s||"NewFile"));return r?e.ParsedURL.ParsedURL.rawPathToEncodedPathString(e.ParsedURL.ParsedURL.substr(r.fullPath,1)):null}deleteFile(t){let s;const n=new Promise((e=>{s=e}));return this.domFileSystem.root.getFile(e.ParsedURL.ParsedURL.encodedPathToRawPathString(t),void 0,function(e){e.remove(r,i.bind(this))}.bind(this),i.bind(this)),n;function r(){s(!0)}function i(e){const n=w.errorMessage(e);console.error(n+" when deleting file '"+this.path()+"/"+t+"'"),s(!1)}}requestFileBlob(t){return new Promise((s=>{function n(e){if("NotFoundError"===e.name)return void s(null);const n=w.errorMessage(e);console.error(n+" when getting content for file '"+this.path()+"/"+t+"'"),s(null)}this.domFileSystem.root.getFile(e.ParsedURL.ParsedURL.encodedPathToRawPathString(t),void 0,(e=>{e.file(s,n.bind(this))}),n.bind(this))}))}requestFileContent(e){return this.serializedFileOperation(e,(()=>this.innerRequestFileContent(e)))}async innerRequestFileContent(t){const s=await this.requestFileBlob(t);if(!s)return{content:null,error:F(y.blobCouldNotBeLoaded),isEncoded:!1};const n=new FileReader,r=e.ParsedURL.ParsedURL.extractExtension(t),i=k.has(r),o=new Promise((e=>{n.onloadend=e}));if(i?n.readAsBinaryString(s):n.readAsText(s),await o,n.error){const e=F(y.cantReadFileSS,{PH1:t,PH2:n.error.toString()});return console.error(e),{content:null,isEncoded:!1,error:e}}let a=null,d=null;try{a=n.result}catch(e){a=null,d=F(y.cantReadFileSS,{PH1:t,PH2:e.message})}return null==a?(d=d||F(y.unknownErrorReadingFileS,{PH1:t}),console.error(d),{content:null,isEncoded:!1,error:d}):{isEncoded:i,content:i?btoa(a):a}}async setFileContent(s,n,r){let i;t.userMetrics.actionTaken(t.UserMetrics.Action.FileSavedInWorkspace);function o(e){e.createWriter(a.bind(this),d.bind(this))}async function a(e){let t;e.onerror=d.bind(this),e.onwriteend=function(){e.onwriteend=i,e.truncate(t.size)},t=r?await(await fetch(`data:application/octet-stream;base64,${n}`)).blob():new Blob([n],{type:"text/plain"}),e.write(t)}function d(e){const t=w.errorMessage(e);console.error(t+" when setting content for file '"+this.path()+"/"+s+"'"),i(void 0)}this.serializedFileOperation(s,(()=>{const t=new Promise((e=>{i=e}));return this.domFileSystem.root.getFile(e.ParsedURL.ParsedURL.encodedPathToRawPathString(s),{create:!0},o.bind(this),d.bind(this)),t}))}renameFile(t,s,n){if(!(s=s?e.ParsedURL.ParsedURL.trim(s):s)||-1!==s.indexOf("/"))return void n(!1);let r,i;function o(e){i=e,i.getFile(s,void 0,a,d.bind(this))}function a(e){n(!1)}function d(e){"NotFoundError"===e.name?r.moveTo(i,s,l,c.bind(this)):n(!1)}function l(e){n(!0,e.name)}function c(e){const r=w.errorMessage(e);console.error(r+" when renaming file '"+this.path()+"/"+t+"' to '"+s+"'"),n(!1)}this.domFileSystem.root.getFile(e.ParsedURL.ParsedURL.encodedPathToRawPathString(t),void 0,function(e){if(e.name===s)return void n(!1);r=e,r.getParent(o.bind(this),c.bind(this))}.bind(this),c.bind(this))}readDirectory(e,t){const s=e.createReader();let n=[];function r(s){const n=w.errorMessage(s);console.error(n+" when reading directory '"+e.fullPath+"'"),t([])}s.readEntries((function e(i){var o;i.length?(n=n.concat((o=i,Array.prototype.slice.call(o||[],0))),s.readEntries(e,r)):t(n.sort())}),r)}requestEntries(e,t){this.domFileSystem.root.getDirectory(e,void 0,function(e){this.readDirectory(e,t)}.bind(this),(function(s){const n=w.errorMessage(s);console.error(n+" when requesting entry '"+e+"'"),t([])}))}saveExcludedFolders(){const e=this.excludedFoldersSetting.get();e[this.path()]=[...this.excludedFoldersInternal],this.excludedFoldersSetting.set(e)}addExcludedFolder(e){this.excludedFoldersInternal.add(e),this.saveExcludedFolders(),this.manager.dispatchEventToListeners(M.ExcludedFolderAdded,e)}removeExcludedFolder(e){this.excludedFoldersInternal.delete(e),this.saveExcludedFolders(),this.manager.dispatchEventToListeners(M.ExcludedFolderRemoved,e)}fileSystemRemoved(){const e=this.excludedFoldersSetting.get();delete e[this.path()],this.excludedFoldersSetting.set(e)}isFileExcluded(t){if(this.excludedFoldersInternal.has(t))return!0;const s=this.manager.workspaceFolderExcludePatternSetting().asRegExp();return Boolean(s&&s.test(e.ParsedURL.ParsedURL.encodedPathToRawPathString(t)))}excludedFolders(){return this.excludedFoldersInternal}searchInPath(s,n){return new Promise((r=>{const i=this.manager.registerCallback((function(t){r(t.map((t=>e.ParsedURL.ParsedURL.rawPathToUrlString(t)))),n.incrementWorked(1)}));t.InspectorFrontendHost.InspectorFrontendHostInstance.searchInPath(i,this.embedderPathInternal,s)}))}indexContent(e){e.setTotalWork(1);const s=this.manager.registerProgress(e);t.InspectorFrontendHost.InspectorFrontendHostInstance.indexPath(s,this.embedderPathInternal,JSON.stringify(this.excludedEmbedderFolders))}mimeFromPath(t){return e.ResourceType.ResourceType.mimeFromURL(t)||"text/plain"}canExcludeFolder(e){return Boolean(e)&&"overrides"!==this.type()}contentType(t){const s=e.ParsedURL.ParsedURL.extractExtension(t);return v.has(s)?e.ResourceType.resourceTypes.Stylesheet:C.has(s)?e.ResourceType.resourceTypes.Document:U.has(s)?e.ResourceType.resourceTypes.Image:I.has(s)?e.ResourceType.resourceTypes.Script:k.has(s)?e.ResourceType.resourceTypes.Other:e.ResourceType.resourceTypes.Document}tooltipForURL(s){const n=i.StringUtilities.trimMiddle(e.ParsedURL.ParsedURL.urlToRawPathString(s,t.Platform.isWin()),150);return F(y.linkedToS,{PH1:n})}supportsAutomapping(){return"overrides"!==this.type()}}const v=new Set(["css","scss","sass","less"]),C=new Set(["htm","html","asp","aspx","phtml","jsp"]),I=new Set(["asp","aspx","c","cc","cljs","coffee","cpp","cs","dart","java","js","jsp","jsx","h","m","mjs","mm","py","sh","ts","tsx","ls"]),U=new Set(["jpeg","jpg","svg","gif","webp","png","ico","tiff","tif","bmp"]),k=new Set(["cmd","com","exe","a","ar","iso","tar","bz2","gz","lz","lzma","z","7z","apk","arc","cab","dmg","jar","pak","rar","zip","3gp","aac","aiff","flac","m4a","mmf","mp3","ogg","oga","raw","sln","wav","wma","webm","mkv","flv","vob","ogv","gifv","avi","mov","qt","mp4","m4p","m4v","mpg","mpeg","jpeg","jpg","gif","webp","png","ico","tiff","tif","bmp"]);var R=Object.freeze({__proto__:null,IsolatedFileSystem:w,BinaryExtensions:k});const x={unableToAddFilesystemS:"Unable to add filesystem: {PH1}"},L=a.i18n.registerUIStrings("models/persistence/IsolatedFileSystemManager.ts",x),b=a.i18n.getLocalizedString.bind(void 0,L);let E;class T extends e.ObjectWrapper.ObjectWrapper{fileSystemsInternal;callbacks;progresses;workspaceFolderExcludePatternSettingInternal;fileSystemRequestResolve;fileSystemsLoadedPromise;constructor(){super(),this.fileSystemsInternal=new Map,this.callbacks=new Map,this.progresses=new Map,t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.FileSystemRemoved,this.onFileSystemRemoved,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.FileSystemAdded,(e=>{this.onFileSystemAdded(e)}),this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.FileSystemFilesChangedAddedRemoved,this.onFileSystemFilesChanged,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.IndexingTotalWorkCalculated,this.onIndexingTotalWorkCalculated,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.IndexingWorked,this.onIndexingWorked,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.IndexingDone,this.onIndexingDone,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.SearchCompleted,this.onSearchCompleted,this);const s=["/Thumbs.db$","/ehthumbs.db$","/Desktop.ini$","/\\$RECYCLE.BIN/"],n=["/\\.DS_Store$","/\\.Trashes$","/\\.Spotlight-V100$","/\\.AppleDouble$","/\\.LSOverride$","/Icon$","/\\._.*$"],r=["/.*~$"];let i=["/node_modules/","/bower_components/","/\\.devtools","/\\.git/","/\\.sass-cache/","/\\.hg/","/\\.idea/","/\\.svn/","/\\.cache/","/\\.project/"];i=t.Platform.isWin()?i.concat(s):t.Platform.isMac()?i.concat(n):i.concat(r);const o=i.join("|");this.workspaceFolderExcludePatternSettingInternal=e.Settings.Settings.instance().createRegExpSetting("workspaceFolderExcludePattern",o,t.Platform.isWin()?"i":""),this.fileSystemRequestResolve=null,this.fileSystemsLoadedPromise=this.requestFileSystems()}static instance(e={forceNew:null}){const{forceNew:t}=e;return E&&!t||(E=new T),E}static removeInstance(){E=null}requestFileSystems(){let e;const s=new Promise((t=>{e=t}));return t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.FileSystemsLoaded,(function(e){const t=e.data,s=[];for(let e=0;e<t.length;++e)s.push(this.innerAddFileSystem(t[e],!1));Promise.all(s).then(n)}),this),t.InspectorFrontendHost.InspectorFrontendHostInstance.requestFileSystems(),s;function n(t){e(t.filter((e=>Boolean(e))))}}addFileSystem(e){return t.userMetrics.actionTaken("overrides"===e?t.UserMetrics.Action.AddFileSystemForOverrides:t.UserMetrics.Action.AddFileSystemToWorkspace),new Promise((s=>{this.fileSystemRequestResolve=s,t.InspectorFrontendHost.InspectorFrontendHostInstance.addFileSystem(e||"")}))}removeFileSystem(e){t.userMetrics.actionTaken("overrides"===e.type()?t.UserMetrics.Action.RemoveFileSystemForOverrides:t.UserMetrics.Action.RemoveFileSystemFromWorkspace),t.InspectorFrontendHost.InspectorFrontendHostInstance.removeFileSystem(e.embedderPath())}waitForFileSystems(){return this.fileSystemsLoadedPromise}innerAddFileSystem(t,s){const n=t.fileSystemPath,r=e.ParsedURL.ParsedURL.rawPathToUrlString(t.fileSystemPath);return w.create(this,r,n,t.type,t.fileSystemName,t.rootURL).then(function(e){if(!e)return null;this.fileSystemsInternal.set(r,e),s&&this.dispatchEventToListeners(M.FileSystemAdded,e);return e}.bind(this))}addPlatformFileSystem(e,t){this.fileSystemsInternal.set(e,t),this.dispatchEventToListeners(M.FileSystemAdded,t)}onFileSystemAdded(t){const{errorMessage:s,fileSystem:n}=t.data;if(s){if("<selection cancelled>"!==s&&e.Console.Console.instance().error(b(x.unableToAddFilesystemS,{PH1:s})),!this.fileSystemRequestResolve)return;this.fileSystemRequestResolve.call(null,null),this.fileSystemRequestResolve=null}else n&&this.innerAddFileSystem(n,!0).then((e=>{this.fileSystemRequestResolve&&(this.fileSystemRequestResolve.call(null,e),this.fileSystemRequestResolve=null)}))}onFileSystemRemoved(t){const s=t.data,n=e.ParsedURL.ParsedURL.rawPathToUrlString(s),r=this.fileSystemsInternal.get(n);r&&(this.fileSystemsInternal.delete(n),r.fileSystemRemoved(),this.dispatchEventToListeners(M.FileSystemRemoved,r))}onFileSystemFilesChanged(t){const s={changed:n.call(this,t.data.changed),added:n.call(this,t.data.added),removed:n.call(this,t.data.removed)};function n(t){const s=new i.MapUtilities.Multimap;for(const n of t){const t=e.ParsedURL.ParsedURL.rawPathToUrlString(n);for(const r of this.fileSystemsInternal.keys()){const i=this.fileSystemsInternal.get(r);if(i&&i.isFileExcluded(e.ParsedURL.ParsedURL.rawPathToEncodedPathString(n)))continue;const o=r.endsWith("/")?r:r+"/";t.startsWith(o)&&s.set(r,t)}}return s}this.dispatchEventToListeners(M.FileSystemFilesChanged,s)}fileSystems(){return[...this.fileSystemsInternal.values()]}fileSystem(e){return this.fileSystemsInternal.get(e)||null}workspaceFolderExcludePatternSetting(){return this.workspaceFolderExcludePatternSettingInternal}registerCallback(e){const t=++j;return this.callbacks.set(t,e),t}registerProgress(e){const t=++j;return this.progresses.set(t,e),t}onIndexingTotalWorkCalculated(e){const{requestId:t,totalWork:s}=e.data,n=this.progresses.get(t);n&&n.setTotalWork(s)}onIndexingWorked(e){const{requestId:s,worked:n}=e.data,r=this.progresses.get(s);r&&(r.incrementWorked(n),r.isCanceled()&&(t.InspectorFrontendHost.InspectorFrontendHostInstance.stopIndexing(s),this.onIndexingDone(e)))}onIndexingDone(e){const{requestId:t}=e.data,s=this.progresses.get(t);s&&(s.done(),this.progresses.delete(t))}onSearchCompleted(e){const{requestId:t,files:s}=e.data,n=this.callbacks.get(t);n&&(n.call(null,s),this.callbacks.delete(t))}}var M;!function(e){e.FileSystemAdded="FileSystemAdded",e.FileSystemRemoved="FileSystemRemoved",e.FileSystemFilesChanged="FileSystemFilesChanged",e.ExcludedFolderAdded="ExcludedFolderAdded",e.ExcludedFolderRemoved="ExcludedFolderRemoved"}(M||(M={}));let j=0;var W=Object.freeze({__proto__:null,IsolatedFileSystemManager:T,get Events(){return M}});class A{isolatedFileSystemManager;workspace;eventListeners;boundFileSystems;constructor(e,t){this.isolatedFileSystemManager=e,this.workspace=t,this.eventListeners=[this.isolatedFileSystemManager.addEventListener(M.FileSystemAdded,this.onFileSystemAdded,this),this.isolatedFileSystemManager.addEventListener(M.FileSystemRemoved,this.onFileSystemRemoved,this),this.isolatedFileSystemManager.addEventListener(M.FileSystemFilesChanged,this.fileSystemFilesChanged,this)],this.boundFileSystems=new Map,this.isolatedFileSystemManager.waitForFileSystems().then(this.onFileSystemsLoaded.bind(this))}static projectId(e){return e}static relativePath(t){const s=t.project().fileSystemBaseURL;return e.ParsedURL.ParsedURL.split(e.ParsedURL.ParsedURL.sliceUrlToEncodedPathString(t.url(),s.length),"/")}static tooltipForUISourceCode(e){return e.project().fileSystemInternal.tooltipForURL(e.url())}static fileSystemType(e){return e.fileSystemInternal.type()}static fileSystemSupportsAutomapping(e){return e.fileSystemInternal.supportsAutomapping()}static completeURL(t,s){const n=t;return e.ParsedURL.ParsedURL.concatenate(n.fileSystemBaseURL,s)}static fileSystemPath(e){return e}fileSystemManager(){return this.isolatedFileSystemManager}onFileSystemsLoaded(e){for(const t of e)this.addFileSystem(t)}onFileSystemAdded(e){const t=e.data;this.addFileSystem(t)}addFileSystem(e){const t=new B(this,e,this.workspace);this.boundFileSystems.set(e.path(),t)}onFileSystemRemoved(e){const t=e.data,s=this.boundFileSystems.get(t.path());s&&s.dispose(),this.boundFileSystems.delete(t.path())}fileSystemFilesChanged(e){const t=e.data;for(const e of t.changed.keysArray()){const s=this.boundFileSystems.get(e);s&&t.changed.get(e).forEach((e=>s.fileChanged(e)))}for(const e of t.added.keysArray()){const s=this.boundFileSystems.get(e);s&&t.added.get(e).forEach((e=>s.fileChanged(e)))}for(const e of t.removed.keysArray()){const s=this.boundFileSystems.get(e);s&&t.removed.get(e).forEach((e=>s.removeUISourceCode(e)))}}dispose(){e.EventTarget.removeEventListeners(this.eventListeners);for(const e of this.boundFileSystems.values())e.dispose(),this.boundFileSystems.delete(e.fileSystemInternal.path())}}class B extends r.Workspace.ProjectStore{fileSystemInternal;fileSystemBaseURL;fileSystemParentURL;fileSystemWorkspaceBinding;fileSystemPathInternal;creatingFilesGuard;constructor(t,s,n){const i=s.path(),o=A.projectId(i);console.assert(!n.project(o));const a=i.substr(i.lastIndexOf("/")+1);super(n,o,r.Workspace.projectTypes.FileSystem,a),this.fileSystemInternal=s,this.fileSystemBaseURL=e.ParsedURL.ParsedURL.concatenate(this.fileSystemInternal.path(),"/"),this.fileSystemParentURL=e.ParsedURL.ParsedURL.substr(this.fileSystemBaseURL,0,i.lastIndexOf("/")+1),this.fileSystemWorkspaceBinding=t,this.fileSystemPathInternal=i,this.creatingFilesGuard=new Set,n.addProject(this),this.populate()}fileSystemPath(){return this.fileSystemPathInternal}fileSystem(){return this.fileSystemInternal}mimeType(e){return this.fileSystemInternal.mimeFromPath(e.url())}initialGitFolders(){return this.fileSystemInternal.initialGitFolders().map((t=>e.ParsedURL.ParsedURL.concatenate(this.fileSystemPathInternal,"/",t)))}filePathForUISourceCode(t){return e.ParsedURL.ParsedURL.sliceUrlToEncodedPathString(t.url(),this.fileSystemPathInternal.length)}isServiceProject(){return!1}requestMetadata(e){const t=H.get(e);if(t)return t;const s=this.filePathForUISourceCode(e),n=this.fileSystemInternal.getMetadata(s).then((function(e){if(!e)return null;return new r.UISourceCode.UISourceCodeMetadata(e.modificationTime,e.size)}));return H.set(e,n),n}requestFileBlob(e){return this.fileSystemInternal.requestFileBlob(this.filePathForUISourceCode(e))}requestFileContent(e){const t=this.filePathForUISourceCode(e);return this.fileSystemInternal.requestFileContent(t)}canSetFileContent(){return!0}async setFileContent(e,t,s){const n=this.filePathForUISourceCode(e);await this.fileSystemInternal.setFileContent(n,t,s)}fullDisplayName(e){const t=e.project().fileSystemParentURL;return e.url().substring(t.length)}canRename(){return!0}rename(t,s,n){if(s===t.name())return void n(!0,t.name(),t.url(),t.contentType());let r=this.filePathForUISourceCode(t);this.fileSystemInternal.renameFile(r,s,function(s,i){if(!s||!i)return void n(!1,i);console.assert(Boolean(i));const o=r.lastIndexOf("/"),a=e.ParsedURL.ParsedURL.substr(r,0,o);r=e.ParsedURL.ParsedURL.encodedFromParentPathAndName(a,i),r=e.ParsedURL.ParsedURL.substr(r,1);const d=e.ParsedURL.ParsedURL.concatenate(this.fileSystemBaseURL,r),l=this.fileSystemInternal.contentType(i);this.renameUISourceCode(t,i),n(!0,i,d,l)}.bind(this))}async searchInFileContent(e,t,s,n){const r=this.filePathForUISourceCode(e),{content:i}=await this.fileSystemInternal.requestFileContent(r);return i?o.TextUtils.performSearchInContent(i,t,s,n):[]}async findFilesMatchingSearchRequest(e,t,s){let n=t;const r=e.queries().slice();r.length||r.push(""),s.setTotalWork(r.length);for(const t of r){const r=await this.fileSystemInternal.searchInPath(e.isRegex()?"":t,s);r.sort(i.StringUtilities.naturalOrderComparator),n=i.ArrayUtilities.intersectOrdered(n,r,i.StringUtilities.naturalOrderComparator),s.incrementWorked(1)}return s.done(),n}indexContent(e){this.fileSystemInternal.indexContent(e)}populate(){const e=this.fileSystemInternal.initialFilePaths();if(0===e.length)return;const s=performance.now();(function n(r){const i=Math.min(r+1e3,e.length);for(let t=r;t<i;++t)this.addFile(e[t]);i<e.length?window.setTimeout(n.bind(this,i),100):"filesystem"===this.type()&&t.userMetrics.workspacesPopulated(performance.now()-s)}).call(this,0)}excludeFolder(t){let s=e.ParsedURL.ParsedURL.sliceUrlToEncodedPathString(t,this.fileSystemBaseURL.length);s.startsWith("/")||(s=e.ParsedURL.ParsedURL.prepend("/",s)),s.endsWith("/")||(s=e.ParsedURL.ParsedURL.concatenate(s,"/")),this.fileSystemInternal.addExcludedFolder(s);for(const e of this.uiSourceCodes())e.url().startsWith(t)&&this.removeUISourceCode(e.url())}canExcludeFolder(e){return this.fileSystemInternal.canExcludeFolder(e)}canCreateFile(){return!0}async createFile(e,t,s,n){const r=this.fileSystemPathInternal+e+(e.endsWith("/")?"":"/")+t;this.creatingFilesGuard.add(r);const i=await this.fileSystemInternal.createFile(e,t);if(!i)return null;const o=this.addFile(i);return o.setContent(s,Boolean(n)),this.creatingFilesGuard.delete(r),o}deleteFile(e){const t=this.filePathForUISourceCode(e);this.fileSystemInternal.deleteFile(t).then((t=>{t&&this.removeUISourceCode(e.url())}))}remove(){this.fileSystemWorkspaceBinding.isolatedFileSystemManager.removeFileSystem(this.fileSystemInternal)}addFile(t){const s=this.fileSystemInternal.contentType(t),n=this.createUISourceCode(e.ParsedURL.ParsedURL.concatenate(this.fileSystemBaseURL,t),s);return this.addUISourceCode(n),n}fileChanged(e){if(this.creatingFilesGuard.has(e))return;const t=this.uiSourceCodeForURL(e);if(t)H.delete(t),t.checkContentUpdated();else{const t=this.fileSystemInternal.contentType(e);this.addUISourceCode(this.createUISourceCode(e,t))}}tooltipForURL(e){return this.fileSystemInternal.tooltipForURL(e)}dispose(){this.removeProject()}}const H=new WeakMap;var N=Object.freeze({__proto__:null,FileSystemWorkspaceBinding:A,FileSystem:B});let O;class q extends e.ObjectWrapper.ObjectWrapper{bindings;originalResponseContentPromises;savingForOverrides;savingSymbol;enabledSetting;workspace;networkUISourceCodeForEncodedPath;interceptionHandlerBound;updateInterceptionThrottler;projectInternal;activeProject;activeInternal;enabled;eventDescriptors;#e=new Map;#t=new WeakMap;#s;#n;constructor(t){super(),this.bindings=new WeakMap,this.originalResponseContentPromises=new WeakMap,this.savingForOverrides=new WeakSet,this.savingSymbol=Symbol("SavingForOverrides"),this.enabledSetting=e.Settings.Settings.instance().moduleSetting("persistenceNetworkOverridesEnabled"),this.enabledSetting.addChangeListener(this.enabledChanged,this),this.workspace=t,this.networkUISourceCodeForEncodedPath=new Map,this.interceptionHandlerBound=this.interceptionHandler.bind(this),this.updateInterceptionThrottler=new e.Throttler.Throttler(50),this.#s=new e.Throttler.Throttler(50),this.#n=new Set,this.projectInternal=null,this.activeProject=null,this.activeInternal=!1,this.enabled=!1,this.workspace.addEventListener(r.Workspace.Events.ProjectAdded,(e=>{this.onProjectAdded(e.data)})),this.workspace.addEventListener(r.Workspace.Events.ProjectRemoved,(e=>{this.onProjectRemoved(e.data)})),se.instance().addNetworkInterceptor(this.canHandleNetworkUISourceCode.bind(this)),l.BreakpointManager.BreakpointManager.instance().addUpdateBindingsCallback(this.networkUISourceCodeAdded.bind(this)),this.eventDescriptors=[],this.enabledChanged(),s.TargetManager.TargetManager.instance().observeTargets(this)}targetAdded(){this.updateActiveProject()}targetRemoved(){this.updateActiveProject()}static instance(e={forceNew:null,workspace:null}){const{forceNew:t,workspace:s}=e;if(!O||t){if(!s)throw new Error("Missing workspace for NetworkPersistenceManager");O=new q(s)}return O}active(){return this.activeInternal}project(){return this.projectInternal}originalContentForUISourceCode(e){const t=this.bindings.get(e);if(!t)return null;const s=t.fileSystem;return this.originalResponseContentPromises.get(s)||null}async enabledChanged(){this.enabled!==this.enabledSetting.get()&&(this.enabled=this.enabledSetting.get(),this.enabled?(t.userMetrics.actionTaken(t.UserMetrics.Action.PersistenceNetworkOverridesEnabled),this.eventDescriptors=[r.Workspace.WorkspaceImpl.instance().addEventListener(r.Workspace.Events.UISourceCodeRenamed,(e=>{this.uiSourceCodeRenamedListener(e)})),r.Workspace.WorkspaceImpl.instance().addEventListener(r.Workspace.Events.UISourceCodeAdded,(e=>{this.uiSourceCodeAdded(e)})),r.Workspace.WorkspaceImpl.instance().addEventListener(r.Workspace.Events.UISourceCodeRemoved,(e=>{this.uiSourceCodeRemovedListener(e)})),r.Workspace.WorkspaceImpl.instance().addEventListener(r.Workspace.Events.WorkingCopyCommitted,(e=>this.onUISourceCodeWorkingCopyCommitted(e.data.uiSourceCode)))],await this.updateActiveProject()):(t.userMetrics.actionTaken(t.UserMetrics.Action.PersistenceNetworkOverridesDisabled),e.EventTarget.removeEventListeners(this.eventDescriptors),await this.updateActiveProject()))}async uiSourceCodeRenamedListener(e){const t=e.data.uiSourceCode;await this.onUISourceCodeRemoved(t),await this.onUISourceCodeAdded(t)}async uiSourceCodeRemovedListener(e){await this.onUISourceCodeRemoved(e.data)}async uiSourceCodeAdded(e){await this.onUISourceCodeAdded(e.data)}async updateActiveProject(){const e=this.activeInternal;if(this.activeInternal=Boolean(this.enabledSetting.get()&&s.TargetManager.TargetManager.instance().rootTarget()&&this.projectInternal),this.activeInternal!==e){if(this.activeInternal&&this.projectInternal){await Promise.all([...this.projectInternal.uiSourceCodes()].map((e=>this.filesystemUISourceCodeAdded(e))));const e=this.workspace.projectsForType(r.Workspace.projectTypes.Network);for(const t of e)await Promise.all([...t.uiSourceCodes()].map((e=>this.networkUISourceCodeAdded(e))))}else this.projectInternal&&(await Promise.all([...this.projectInternal.uiSourceCodes()].map((e=>this.filesystemUISourceCodeRemoved(e)))),this.networkUISourceCodeForEncodedPath.clear());se.instance().refreshAutomapping()}}encodedPathFromUrl(t,s){return e.ParsedURL.ParsedURL.rawPathToEncodedPathString(this.rawPathFromUrl(t,s))}rawPathFromUrl(t,s){if(!this.activeInternal&&!s||!this.projectInternal)return i.DevToolsPath.EmptyRawPathString;let n=e.ParsedURL.ParsedURL.urlWithoutHash(t.replace(/^https?:\/\//,""));n.endsWith("/")&&-1===n.indexOf("?")&&(n=e.ParsedURL.ParsedURL.concatenate(n,"index.html"));let r=q.encodeEncodedPathToLocalPathParts(n);const o=A.fileSystemPath(this.projectInternal.id()),a=r.join("/");if(o.length+a.length>200){const t=r[0],s=r[r.length-1],o=s?s.substr(0,10)+"-":"",d=e.ParsedURL.ParsedURL.extractExtension(n),l=d?"."+d.substr(0,10):"";r=[t,"longurls",o+i.StringUtilities.hashCode(a).toString(16)+l]}return e.ParsedURL.ParsedURL.join(r,"/")}static encodeEncodedPathToLocalPathParts(e){const s=[];for(const n of this.#r(e)){if(!n)continue;let e=encodeURI(n).replace(/[\/\*]/g,(e=>"%"+e[0].charCodeAt(0).toString(16).toUpperCase()));if(t.Platform.isWin()){e=e.replace(/[:\?]/g,(e=>"%"+e[0].charCodeAt(0).toString(16).toUpperCase())),D.has(e.toLowerCase())&&(e=e.split("").map((e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())).join(""));"."===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)+"%2E")}s.push(e)}return s}static#r(t){const s=(t=e.ParsedURL.ParsedURL.urlWithoutHash(t)).indexOf("?");if(-1===s)return t.split("/");if(0===s)return[t];const n=t.substr(s),r=t.substr(0,t.length-n.length).split("/");return r[r.length-1]+=n,r}fileUrlFromNetworkUrl(t,s){return this.projectInternal?e.ParsedURL.ParsedURL.concatenate(this.projectInternal.fileSystemPath(),"/",this.encodedPathFromUrl(t,s)):i.DevToolsPath.EmptyUrlString}getHeadersUISourceCodeFromUrl(t){const s=this.fileUrlFromNetworkUrl(t,!0),n=e.ParsedURL.ParsedURL.substring(s,0,s.lastIndexOf("/")),i=e.ParsedURL.ParsedURL.concatenate(n,"/",_);return r.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(i)}async getOrCreateHeadersUISourceCodeFromUrl(s){let n=this.getHeadersUISourceCodeFromUrl(s);if(!n&&this.projectInternal){const r=this.encodedPathFromUrl(s,!0),i=e.ParsedURL.ParsedURL.substring(r,0,r.lastIndexOf("/"));n=await this.projectInternal.createFile(i,_,""),t.userMetrics.actionTaken(t.UserMetrics.Action.HeaderOverrideFileCreated)}return n}decodeLocalPathToUrlPath(e){try{return unescape(e)}catch(e){console.error(e)}return e}async#i(e){const t=this.bindings.get(e);if(t){const e=this.#o(t.network);await e.run(this.#a.bind(this,t))}}async#d(e){const t=this.bindings.get(e);t&&await this.#a(t)}#a(e){return this.bindings.delete(e.network),this.bindings.delete(e.fileSystem),se.instance().removeBinding(e)}async#l(e,t){const s=this.#o(e);await s.run((async()=>{const s=this.bindings.get(e);if(s){const{network:n,fileSystem:r}=s;if(e===n&&t===r)return;await this.#d(e),await this.#d(t)}await this.#c(e,t)}))}#o(t){let s=this.#t.get(t);return s||(s=new e.Mutex.Mutex,this.#t.set(t,s)),s}async#c(e,t){const s=new ue(e,t);this.bindings.set(e,s),this.bindings.set(t,s),await se.instance().addBinding(s);const n=this.savingForOverrides.has(e)?e:t,{content:r,isEncoded:i}=await n.requestContent();se.instance().syncContent(n,r||"",i)}onUISourceCodeWorkingCopyCommitted(e){this.saveUISourceCodeForOverrides(e),this.updateInterceptionPatterns()}canSaveUISourceCodeForOverrides(e){return this.activeInternal&&e.project().type()===r.Workspace.projectTypes.Network&&!this.bindings.has(e)&&!this.savingForOverrides.has(e)}async saveUISourceCodeForOverrides(t){if(!this.canSaveUISourceCodeForOverrides(t))return;this.savingForOverrides.add(t);let s=this.encodedPathFromUrl(t.url());const{content:n,isEncoded:r}=await t.requestContent(),i=s.lastIndexOf("/"),o=e.ParsedURL.ParsedURL.substring(s,i+1),a=e.ParsedURL.ParsedURL.encodedPathToRawPathString(o);s=e.ParsedURL.ParsedURL.substr(s,0,i),this.projectInternal&&await this.projectInternal.createFile(s,a,n??"",r),this.fileCreatedForTest(s,a),this.savingForOverrides.delete(t)}fileCreatedForTest(e,t){}patternForFileSystemUISourceCode(e){const t=A.relativePath(e);if(t.length<2)return"";if("longurls"===t[1]&&2!==t.length)return"file:"===t[0]?"file:///*":"http?://"+t[0]+"/*";const s=this.decodeLocalPathToUrlPath(this.decodeLocalPathToUrlPath(t.join("/")));return s.startsWith("file:/")?"file:///"+s.substring("file:/".length):"http?://"+s}async onUISourceCodeAdded(e){await this.networkUISourceCodeAdded(e),await this.filesystemUISourceCodeAdded(e)}canHandleNetworkUISourceCode(e){return this.activeInternal&&!e.url().startsWith("snippet://")}async networkUISourceCodeAdded(t){if(t.project().type()!==r.Workspace.projectTypes.Network||!this.canHandleNetworkUISourceCode(t))return;const s=e.ParsedURL.ParsedURL.urlWithoutHash(t.url());this.networkUISourceCodeForEncodedPath.set(this.encodedPathFromUrl(s),t);const n=this.projectInternal.uiSourceCodeForURL(this.fileUrlFromNetworkUrl(s));n&&await this.#l(t,n),this.#h(t)}async filesystemUISourceCodeAdded(t){if(!this.activeInternal||t.project()!==this.projectInternal)return;this.updateInterceptionPatterns();const s=A.relativePath(t),n=this.networkUISourceCodeForEncodedPath.get(e.ParsedURL.ParsedURL.join(s,"/"));n&&await this.#l(n,t)}async#u(e){const t=(await e.requestContent()).content||"[]";let s=[];try{if(s=JSON.parse(t),!s.every($))throw"Type mismatch after parsing"}catch(t){return console.error("Failed to parse",e.url(),"for locally overriding headers."),[]}return s}#p(e){const t=this.decodeLocalPathToUrlPath(e);return{singlyDecodedPath:t,decodedPath:this.decodeLocalPathToUrlPath(t)}}async generateHeaderPatterns(t){const s=await this.#u(t),n=A.relativePath(t),r=e.ParsedURL.ParsedURL.slice(e.ParsedURL.ParsedURL.join(n,"/"),0,-_.length),{singlyDecodedPath:i,decodedPath:o}=this.#p(r);let a;return a=n.length>2&&"longurls"===n[1]&&s.length?this.#m(o,s,n[0]):o.startsWith("file:/")?this.#g(e.ParsedURL.ParsedURL.substring(o,"file:/".length),s):this.#f(o,s),{...a,path:i}}#f(e,t){const s=new Set,n=[];for(const r of t){s.add("http?://"+e+r.applyTo),""===e&&(s.add("file:///"+r.applyTo),n.push({applyToRegex:new RegExp("^file:///"+G(e+r.applyTo)+"$"),headers:r.headers}));const{head:t,tail:i}=V(r.applyTo);i?(s.add("http?://"+e+t),n.push({applyToRegex:new RegExp(`^${G(e+t)}(${G(i)})?$`),headers:r.headers})):n.push({applyToRegex:new RegExp(`^${G(e+r.applyTo)}$`),headers:r.headers})}return{headerPatterns:s,overridesWithRegex:n}}#g(e,t){const s=new Set,n=[];for(const r of t)s.add("file:///"+e+r.applyTo),n.push({applyToRegex:new RegExp(`^file:/${G(e+r.applyTo)}$`),headers:r.headers});return{headerPatterns:s,overridesWithRegex:n}}#m(t,s,n){const r=new Set;let{decodedPath:i}=this.#p(e.ParsedURL.ParsedURL.concatenate(n,"/*"));const o=t.startsWith("file:/");o&&(t=e.ParsedURL.ParsedURL.substring(t,"file:/".length),i=e.ParsedURL.ParsedURL.substring(i,"file:/".length)),r.add((o?"file:///":"http?://")+i);const a=[];for(const e of s)a.push({applyToRegex:new RegExp(`^${o?"file:/":""}${G(t+e.applyTo)}$`),headers:e.headers});return{headerPatterns:r,overridesWithRegex:a}}async updateInterceptionPatternsForTests(){await this.#S()}updateInterceptionPatterns(){this.updateInterceptionThrottler.schedule(this.#S.bind(this))}async#S(){if(this.#e.clear(),!this.activeInternal||!this.projectInternal)return s.NetworkManager.MultitargetNetworkManager.instance().setInterceptionHandlerForPatterns([],this.interceptionHandlerBound);let e=new Set;for(const t of this.projectInternal.uiSourceCodes()){const s=this.patternForFileSystemUISourceCode(t);if(u.Runtime.experiments.isEnabled(u.Runtime.ExperimentName.HEADER_OVERRIDES)&&t.name()===_){const{headerPatterns:s,path:n,overridesWithRegex:r}=await this.generateHeaderPatterns(t);s.size>0&&(e=new Set([...e,...s]),this.#e.set(n,r))}else e.add(s);const{head:n,tail:r}=V(s);r&&e.add(n)}return 